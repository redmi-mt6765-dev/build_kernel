name: Build Kernel

on:
  workflow_dispatch:

jobs:
  Build-Kernel:
    runs-on: ubuntu-22.04
    defaults:
      run:
        shell: bash
        working-directory: /home/runner

    steps:

      - name: Set up build environment
        run: |
          sudo apt-get update
          sudo apt-get install git ccache automake flex lzop bison gperf build-essential zip curl zlib1g-dev g++-multilib libxml2-utils bzip2 libbz2-dev libbz2-1.0 libghc-bzlib-dev squashfs-tools pngcrush schedtool dpkg-dev liblz4-tool make optipng maven libssl-dev pwgen libswitch-perl policycoreutils minicom libxml-sax-base-perl libxml-simple-perl bc libc6-dev-i386 lib32ncurses5-dev libx11-dev lib32z-dev libgl1-mesa-dev xsltproc unzip device-tree-compiler python2 python3

      - name: Clone and download toolchains
        run: |
          mkdir toolchains
          cd toolchains
          git clone --branch android10-release --single-branch https://android.googlesource.com/platform/prebuilts/gcc/linux-x86/aarch64/aarch64-linux-android-4.9
          git clone --branch android10-release --single-branch https://android.googlesource.com/platform/prebuilts/gcc/linux-x86/arm/arm-linux-androideabi-4.9
          wget https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/android10-release/clang-r353983c.tar.gz
          mkdir clang-r353983c
          tar -C clang-r353983c/ -zxvf clang-r353983c.tar.gz
          cd ~

      - name: Clone kernel source
        run: git clone --branch dandelion-q-oss --single-branch https://github.com/redmi-mt6765-dev/kernel.git android-kernel

      - name: Compile kernel source
        run: |
          cd android-kernel
          make O=out ARCH=arm64 dandelion_defconfig
          PATH="$HOME/toolchains/clang-r353983c/bin:$HOME/toolchains/aarch64-linux-gnu/bin:$HOME/toolchains/arm-linux-androideabi/bin:${PATH}" \
          make -j$(nproc --all) O=out \
                      ARCH=arm64 \
                      CC=clang \
                      CLANG_TRIPLE=aarch64-linux-gnu- \
                      CROSS_COMPILE=aarch64-linux-android- \
                      CROSS_COMPILE_ARM32=arm-linux-androideabi-
